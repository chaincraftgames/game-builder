#!/bin/bash

# Setup Generated Games Directory with OpenSWE Configuration
# This script creates the generated-games directory and adds necessary prompts/instructions

echo "ðŸŽ® Setting up generated-games directory for OpenSWE..."

# Navigate to workspace root
WORKSPACE_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../../../../.." && pwd)"
echo "ðŸ“ Workspace root: $WORKSPACE_ROOT"

# Create generated-games directory structure
GENERATED_GAMES_DIR="$WORKSPACE_ROOT/generated-games"
echo "ðŸ“ Creating generated-games directory: $GENERATED_GAMES_DIR"

mkdir -p "$GENERATED_GAMES_DIR"/{.openswe,templates,examples}

# Copy prompts and instructions to generated-games
echo "ðŸ“ Adding OpenSWE instructions to generated-games..."

# Copy the main game generation prompt
cp "$WORKSPACE_ROOT/game-builder/src/ai/generate/prompts/chaincraft-game-generation.md" \
   "$GENERATED_GAMES_DIR/.openswe/"

# Create a project-specific README for OpenSWE
cat > "$GENERATED_GAMES_DIR/.openswe/README.md" << 'EOF'
# OpenSWE Configuration for ChainCraft Game Generation

This directory contains instructions and configuration for OpenSWE when generating games.

## Files

- `chaincraft-game-generation.md` - Main prompt for game generation
- `project-context.md` - Project-specific context and constraints
- `README.md` - This file

## Usage

When OpenSWE operates on this directory, it will:
1. Read instructions from `.openswe/` 
2. Reference framework code from `../text-game-engine/`
3. Study examples from `../gamedef/`
4. Generate games in subdirectories

## Generated Game Structure

Each game will be created in its own subdirectory:
```
generated-games/
â”œâ”€â”€ .openswe/           # Instructions (this directory)
â”œâ”€â”€ game-name-1/        # Generated game
â”œâ”€â”€ game-name-2/        # Another generated game
â””â”€â”€ ...
```
EOF

# Create project context file
cat > "$GENERATED_GAMES_DIR/.openswe/project-context.md" << 'EOF'
# ChainCraft Project Context

## Project Structure

You are working in a ChainCraft game generation workspace with the following structure:

```
../
â”œâ”€â”€ text-game-engine/   # ECS framework - study this for patterns
â”œâ”€â”€ gamedef/           # Example game definitions
â”œâ”€â”€ game-builder/      # Build system (reference only)
â””â”€â”€ generated-games/   # Your working directory (here)
```

## Key References

### Framework Documentation
- `../text-game-engine/docs/` - Core concepts and API documentation
- `../text-game-engine/modules/rps/` - Complete working example

### Example Games
- `../gamedef/` - Game definition examples and patterns

## Generation Guidelines

1. **Study the RPS Example**: `../text-game-engine/modules/rps/src/index.ts`
2. **Use ECS Patterns**: Follow Entity-Component-System architecture
3. **Generate Complete Games**: Include all necessary files for a working game
4. **Follow Conventions**: Match patterns from existing examples

## Output Structure

Generate each game in its own directory with this structure:
```
game-name/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts        # Main game entry point
â”‚   â”œâ”€â”€ components/     # Game-specific components
â”‚   â”œâ”€â”€ systems/        # Game logic systems
â”‚   â””â”€â”€ actions/        # Player actions
â”œâ”€â”€ config/
â”‚   â””â”€â”€ game.json       # Game configuration
â””â”€â”€ README.md           # Game documentation
```
EOF

# Create a basic gitignore for generated content
cat > "$GENERATED_GAMES_DIR/.gitignore" << 'EOF'
# Generated game content - ignore everything except configuration
*
!.openswe/
!.gitignore
!README.md

# Allow specific games to be committed if needed
# !example-game/
EOF

# Create main README for generated-games
cat > "$GENERATED_GAMES_DIR/README.md" << 'EOF'
# Generated Games

This directory contains games generated by OpenSWE using the ChainCraft text-game-engine.

## OpenSWE Configuration

OpenSWE instructions are in the `.openswe/` directory:
- Game generation prompts
- Project context and guidelines
- Framework references

## Usage

1. Configure OpenSWE to operate on this directory
2. OpenSWE will read instructions from `.openswe/`
3. Generated games appear as subdirectories
4. Each game is self-contained and playable

## Generated Game Structure

```
game-name/
â”œâ”€â”€ src/           # Game source code
â”œâ”€â”€ config/        # Game configuration  
â””â”€â”€ README.md      # Game documentation
```

## Framework Integration

Generated games use the ChainCraft text-game-engine:
- ECS architecture with entities, components, systems
- Pre-built components for common game mechanics
- Established patterns from example games
EOF

echo "âœ… Generated-games directory setup complete!"
echo ""

# Copy OpenSWE environment configuration
echo "ï¿½ Copying OpenSWE environment configuration..."
if [ -f "$WORKSPACE_ROOT/open-swe/apps/cli/.env" ]; then
    cp "$WORKSPACE_ROOT/open-swe/apps/cli/.env" "$GENERATED_GAMES_DIR/.env"
    echo "âœ… Environment configuration copied to generated-games/"
else
    echo "âš ï¸  OpenSWE .env file not found - run setup-openswe.sh first"
fi
echo ""

echo "ï¿½ðŸ“ Directory structure created:"
echo "generated-games/"
echo "â”œâ”€â”€ .openswe/              # OpenSWE instructions"
echo "â”œâ”€â”€ .env                   # Environment configuration"
echo "â”œâ”€â”€ .gitignore             # Git configuration"
echo "â””â”€â”€ README.md              # Usage documentation"
echo ""
echo "ðŸŽ¯ OpenSWE can now operate on: $GENERATED_GAMES_DIR"
